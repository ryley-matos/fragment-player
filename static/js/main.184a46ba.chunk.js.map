{"version":3,"sources":["../../src/index.js","App.js","index.js"],"names":["getFragmentIdx","fragments","seconds","startAt","endAt","FragmentPlayerContext","React","children","loadVideo","canvasRef","useRef","contentRef","drawInterval","seekTimeout","tmpPlaying","timeout","undefined","useState","playing","setPlaying","currentTime","setCurrentTime","useMemo","totalLength","enrichedFragments","tmpLength","f","tmp","enrichFragments","currentVideoIdx","width","height","setSize","ready","setReady","loadedIdx","setLoadedWrapper","useEffect","vidContainer","document","setLoadedIdx","idx","togglePlay","videos","video","style","ref","onClick","useLayoutEffect","onResize","clientHeight","window","id","cached","fragmentDummy","loadVidIdx","v","onCanPlay","tmpPause","ms","clearTimeout","setTimeout","fragment","ctx","clearInterval","setInterval","newTime","value","seekTo","src","fragmentBegin","fragmentEnd","App","visible","setVisisble","edit","setEdit","slice","Consumer","margin","type","min","max","onChange","e","parseInt","target","ReactDOM","render","getElementById"],"mappings":"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","file":"static/js/main.184a46ba.chunk.js","sourcesContent":["import React, { useRef, useMemo, useState, useEffect, useLayoutEffect, useCallback }  from 'react';\n\n/*\n  Very roughly based off totimedli's solution on stack overflow:\n    https://stackoverflow.com/questions/34097834/html5-video-how-to-do-a-seamless-play-and-or-loop-of-several-videos\n*/\n\nconst enrichFragments = (fragments) => {\n  var totalLength = 0\n  const enrichedFragments = fragments?.map((f) => {\n    const tmpLength = f.fragmentEnd - f.fragmentBegin\n    const tmp = {...f, startAt: totalLength, endAt: totalLength + tmpLength}\n    totalLength += tmpLength\n    return tmp\n  })\n  return {totalLength, enrichedFragments}\n}\n\nconst getFragmentIdx = (fragments, seconds) => fragments.findIndex(({startAt, endAt}) => seconds >= startAt && seconds <= endAt)\n\nconst FragmentPlayerContext = React.createContext({})\n\n/*\n  Fragment:\n    fragmentBegin: seconds (relative to original video)\n    fragmentEnd: seconds (relative to original video)\n    src: video source\n*/\n\nconst usePrev = value => {\n  const ref = useRef()\n  useEffect(() => {\n    ref.current = value\n  })\n  return ref.current\n}\n\n\nfunction FragmentPlayerProvider({children, fragments, loadVideo}) {\n  const canvasRef = useRef()\n  const contentRef = useRef()\n  const drawInterval = useRef()\n\n  //handles pausing while seeking\n  const seekTimeout = useRef({tmpPlaying: undefined, timeout: undefined})\n\n  const [playing, setPlaying] = useState(false)\n  const [currentTime, setCurrentTime] = useState(0)\n  const {totalLength, enrichedFragments} = useMemo(() => enrichFragments(fragments), [fragments])\n  const currentVideoIdx = getFragmentIdx(enrichedFragments, currentTime)\n  const [{ width, height }, setSize] = useState({})\n  const [ready, setReady] = useState(false)\n  const [loadedIdx, setLoadedWrapper] = useState(-1)\n\n  useEffect(() => {\n    const vidContainer = document.createElement('div')\n    vidContainer.style.display = 'none'\n    vidContainer.id = 'fragment-dummy'\n    document.body.appendChild(\n      vidContainer\n    )\n    return () => document.body.removeChild(vidContainer)\n  }, [])\n\n  const setLoadedIdx = (idx) => {\n    setLoadedWrapper(idx)\n  }\n\n  const togglePlay = () => {\n    if (playing) {\n      setPlaying(false)\n      videos[currentVideoIdx].pause()\n    }\n    else {\n      setPlaying(true)\n      videos[currentVideoIdx].play()\n    }\n  }\n\n  const video = loadVideo ? \n    <div style={{width: '100%', height: '100%', }} ref={contentRef}>\n      <canvas ref={canvasRef} style={{width: '100%'}}  onClick={togglePlay}/>\n    </div>\n    :\n    null\n\n  useLayoutEffect(() => {\n    const onResize = () => {\n      setSize({\n        width: contentRef?.current?.clientWidth,\n        height: contentRef?.current?.clientHeight,\n      })\n    }\n    window.addEventListener('resize', onResize)\n    return () => window.removeEventListener('resize', onResize)\n  })\n\n  useEffect(() => {\n    setSize({\n      width: contentRef?.current?.clientWidth,\n      height: contentRef?.current?.clientHeight,\n    })\n  }, [canvasRef?.current, contentRef?.current, loadVideo, ready])\n\n  const videos = useMemo(() => {\n    setReady(false)\n    return loadVideo ? enrichedFragments?.map((f, idx) => {\n      const id = `${f.fragmentBegin}-${f.fragmentEnd}-${f.src}`\n      const cached = document.getElementById(id)\n      const tmp = cached || document.createElement('video')\n      if (!idx && !cached) {\n        tmp.src = f.src\n        tmp.preload = \"auto\"\n        tmp.currentTime = f.fragmentBegin\n        tmp.load()\n        tmp.onloadeddata = () => {\n          setReady(true)\n          setLoadedIdx(idx)\n        }\n      } else if (!idx) {\n        setReady(true)\n        setLoadedIdx(idx)\n      }\n      if (!cached) {\n        tmp.id = id\n        const fragmentDummy = document.getElementById('fragment-dummy')\n        fragmentDummy.appendChild(tmp)\n      }\n      return tmp\n    }) : []\n  }, [enrichedFragments, canvasRef?.current, loadVideo])\n\n  useEffect(() => {\n    const loadVidIdx = loadedIdx + 1\n    const v = videos[loadVidIdx]\n    const f = enrichedFragments[loadVidIdx]\n    if (v) {\n      v.src = f.src\n      v.preload=\"auto\"\n      v.currentTime = f.fragmentBegin\n      v.load()\n      v.onloadeddata = () => {\n        setLoadedIdx(loadVidIdx)\n      }\n    }\n  }, [loadedIdx])\n  \n\n  useEffect(() => {\n    const video = videos[currentVideoIdx]\n    if (!video) {\n      return\n    }\n    const onCanPlay = () => video.play()\n    if (playing && video) {\n      video.addEventListener('canplay', onCanPlay)\n    }\n    return () => {\n      video.pause()\n      video.removeEventListener('canplay', onCanPlay)\n    }\n  }, [enrichedFragments, currentVideoIdx, playing, videos])\n\n\n  //pause for ms then return to original play state\n  const tmpPause = (ms) => {\n    if (seekTimeout?.current?.tmpPlaying === undefined) {\n      seekTimeout.current.tmpPlaying = playing\n    }\n    setPlaying(false)\n    clearTimeout(seekTimeout.current.timeout)\n    seekTimeout.current.timeout = setTimeout(() => {\n      setPlaying(seekTimeout?.current?.tmpPlaying)\n      seekTimeout.current.tmpPlaying = undefined\n    }, ms)\n  }\n\n\n  const seekTo = (seconds) => {\n    tmpPause(100)\n    const newIdx = getFragmentIdx(enrichedFragments, currentTime)\n    if (newIdx === currentVideoIdx) {\n      const fragment = enrichedFragments[currentVideoIdx]\n      videos[currentVideoIdx].currentTime = seconds - fragment.startAt + fragment?.fragmentBegin\n    }\n    setCurrentTime(seconds)\n  }\n\n  \n\n  useEffect(() => {\n    if (playing) {\n      videos[currentVideoIdx].play()\n    }\n  }, [currentVideoIdx, currentTime, playing])\n\n  useEffect(() => {\n    for (var v of videos) {\n      v.pause()\n    }\n    if (!videos[currentVideoIdx] || !ready || !canvasRef?.current || !video) {\n      return\n    }\n    const fragment = enrichedFragments[currentVideoIdx]\n    videos[currentVideoIdx].currentTime = currentTime - fragment.startAt + fragment?.fragmentBegin\n\n    canvasRef.current.width = width\n    canvasRef.current.height = height\n    const ctx = canvasRef?.current?.getContext('2d')\n\n    ctx.drawImage(videos[currentVideoIdx],0, 0, width, height)\n    clearInterval(drawInterval?.current)\n    drawInterval.current = setInterval(() => {\n      const newTime = videos[currentVideoIdx]?.currentTime - enrichedFragments[currentVideoIdx]?.fragmentBegin + enrichedFragments[currentVideoIdx]?.startAt\n      if (newTime >= totalLength) {\n        setCurrentTime(totalLength)\n        togglePlay()\n      }\n      else if (newTime <= 0) {\n        setCurrentTime(0)\n        togglePlay()\n      }\n      else {\n        setCurrentTime(newTime)\n      }\n      ctx.drawImage(videos[currentVideoIdx],0, 0, width, height)\n    }, 30)\n  }, [enrichedFragments, currentVideoIdx, width, height, ready])\n\n  useEffect(() => {\n    if (!loadVideo && videos) {\n        setPlaying(false)\n    }\n  }, [loadVideo, videos, contentRef?.current])\n    \n  \n  return (\n    <FragmentPlayerContext.Provider\n      value={{\n        seekTo,\n        togglePlay,\n        setPlaying,\n        ready,\n        currentTime,\n        totalLength,\n        video,\n        videos,\n        playing,\n        currentVideoIdx,\n        tmpPause,\n      }}\n    >\n      {children}\n    </FragmentPlayerContext.Provider>\n  );\n}\n\nexport default FragmentPlayerProvider\nexport { FragmentPlayerContext }\n","import React, { useState } from 'react'\nimport FragmentPlayerProvider, {FragmentPlayerContext} from 'fragment-player'\n\nconst fragments = [\n  {\n    src: 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/SubaruOutbackOnStreetAndDirt.mp4',\n    fragmentBegin: 0,\n    fragmentEnd: 5,\n  },\n  {\n    src: 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerFun.mp4',\n    fragmentBegin: 1,\n    fragmentEnd: 25,\n  },\n  {\n    src: 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/WeAreGoingOnBullrun.mp4',\n    fragmentBegin: 1,\n    fragmentEnd: 3,\n  },\n]\n  \nconst App = () => {\n  const [visible, setVisisble] = useState(false)\n  const [edit, setEdit] = useState(false)\n  return (\n    <FragmentPlayerProvider fragments={edit ? [...fragments.slice(0, 1), {...fragments[1], fragmentEnd: fragments[1].fragmentEnd + 10}, ...fragments.slice(2)] : fragments} loadVideo={visible}>\n      <FragmentPlayerContext.Consumer>\n        {({seekTo, currentTime, totalLength, video , setPlaying, ready}) => {\n          return (\n            <div style={{width: '75%', margin: 'auto'}}>\n              <button onClick={() => setVisisble(true)}>Show Video</button>\n              <button onClick={() => setEdit(!edit)}>Simulate Edit</button>\n              <button onClick={() => setPlaying(true)}>Play</button>\n              <button onClick={() => setPlaying(false)}>Pause</button>\n              {video}\n              <input style={{width: '100%'}} type=\"range\" min={0} max={totalLength} value={currentTime} onChange={(e) => seekTo(parseInt(e.target.value))}/>\n              <div>{ready ? 'Video Ready' : 'Video Loading...'}</div>\n            </div>\n          )\n        }}\n      </FragmentPlayerContext.Consumer>\n    </FragmentPlayerProvider>\n  )\n}\n\nexport default App\n","import './index.css'\n\nimport React from 'react'\nimport ReactDOM from 'react-dom'\nimport App from './App'\n\nReactDOM.render(<App />, document.getElementById('root'))\n"],"sourceRoot":""}